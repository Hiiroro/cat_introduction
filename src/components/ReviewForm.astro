---
import "../styles/global.css";
---

<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>レビュー | 猫の手も借りたい</title>
    <style>
      .review-form,
      .current-rating,
      .review-log {
        background-color: #fff;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        margin-bottom: 1rem;
      }

      .rating-container {
        text-align: center;
      }

      .rating img {
        width: 40px;
        cursor: pointer;
        margin: 0 2px;
      }

      .rating-value {
        margin-top: 0.3rem;
        color: red;
        font-weight: bold;
        text-align: left;
      }

      .log-entry {
        margin-bottom: 1rem;
        border-bottom: 1px solid #ccc;
        padding-bottom: 0.5rem;
      }

      .total-score {
        font-size: 1.2rem;
        font-weight: bold;
        color: red;
        margin: 0.4rem 0;
      }

      .small-score {
        font-size: 0.85rem;
        color: #555;
      }

      select {
        width: 100%;
        padding: 0.3rem;
        margin-bottom: 0.5rem;
      }
    </style>
  </head>

  <body>
    <main>
      <!-- 1. フォーム -->
      <section class="review-form">
        <h3 style="text-align:center">レビューを書いてください</h3>

        <form id="reviewForm">
          <!-- UI -->
          <label>UIの使いやすさ（5段階）</label>
          <select id="uiScore" required>
            <option value="5">5（とても良い）</option>
            <option value="4">4（良い）</option>
            <option value="3">3（普通）</option>
            <option value="2">2（やや不便）</option>
            <option value="1">1（悪い）</option>
          </select>

          <!-- 機能 -->
          <label>機能の充実度（5段階）</label>
          <select id="featureScore" required>
            <option value="5">5（とても良い）</option>
            <option value="4">4（良い）</option>
            <option value="3">3（普通）</option>
            <option value="2">2（不足あり）</option>
            <option value="1">1（不満）</option>
          </select>

          <!-- 安定性 -->
          <label>アプリの安定性（5段階）</label>
          <select id="stabilityScore" required>
            <option value="5">5（とても安定）</option>
            <option value="4">4（安定）</option>
            <option value="3">3（普通）</option>
            <option value="2">2（やや不安定）</option>
            <option value="1">1（不安定）</option>
          </select>

          <!-- 総合評価 -->
          <div class="rating-container">
            <p>総合評価（0.5刻み）</p>
            <div class="rating" id="rating"></div>
            <p id="ratingValue" class="rating-value">現在の総合評価: 0.0</p>
          </div>

          <label for="reviewText">コメント:</label>
          <textarea
            id="reviewText"
            name="reviewText"
            placeholder="レビューを入力してください..."
            required
          ></textarea>

          <button type="submit">投稿する</button>
        </form>
      </section>

      <!-- 2. 平均評価 -->
      <section class="current-rating">
        <h3>平均評価（総合）</h3>
        <p id="averageRating">まだ投稿がありません</p>
      </section>

      <!-- 3. 過去投稿ログ -->
      <section class="review-log">
        <h3 style="text-align:center">過去の投稿</h3>
        <div id="logContainer"></div>
      </section>
    </main>

    <script type="module">
      const ratingContainer = document.getElementById("rating");
      const ratingValue = document.getElementById("ratingValue");
      const logContainer = document.getElementById("logContainer");
      const averageRating = document.getElementById("averageRating");

      const total = 5;
      let currentRating = 0;

      // ★ undefinedを "-" にする関数
      const safe = (v) => (v ?? "-");

      /* 肉球生成 */
      for (let i = 1; i <= total; i++) {
        const img = document.createElement("img");
        img.src = "/paw_empty.png";
        img.dataset.index = i;
        img.classList.add("paw");
        ratingContainer.appendChild(img);

        img.addEventListener("mousemove", (e) => handleHover(e, i));
        img.addEventListener("mouseleave", () => highlightPaws(currentRating));
        img.addEventListener("click", (e) => handleClick(e, i));
      }

      function handleHover(e, index) {
        const rect = e.target.getBoundingClientRect();
        const isLeft = e.clientX - rect.left < rect.width / 2;
        const value = index - (isLeft ? 0.5 : 0);
        highlightPaws(value);
      }

      function handleClick(e, index) {
        const rect = e.target.getBoundingClientRect();
        const isLeft = e.clientX - rect.left < rect.width / 2;
        currentRating = index - (isLeft ? 0.5 : 0);
        highlightPaws(currentRating);
        ratingValue.textContent = `現在の総合評価: ${currentRating.toFixed(1)}`;
      }

      function highlightPaws(value) {
        const paws = document.querySelectorAll(".paw");
        paws.forEach((paw, i) => {
          const idx = i + 1;
          if (value >= idx) paw.src = "/paw_full.png";
          else if (value >= idx - 0.5) paw.src = "/paw_half.png";
          else paw.src = "/paw_empty.png";
        });
      }

      /* 過去レビューの取得 */
      async function fetchReviews() {
        const res = await fetch("/api/reviews");
        const reviews = await res.json();

        logContainer.innerHTML = "";
        let totalScore = 0;

        reviews.forEach(entry => {
          totalScore += entry.rating;

          const logEntry = document.createElement("div");
          logEntry.classList.add("log-entry");
          logEntry.innerHTML = `
            <div class="small-score"><strong>UI:</strong> ${safe(entry.ui)} / 5</div>
            <div class="small-score"><strong>機能:</strong> ${safe(entry.features)} / 5</div>
            <div class="small-score"><strong>安定性:</strong> ${safe(entry.stability)} / 5</div>

            <div class="total-score"><strong>総合評価:</strong> ${safe(entry.rating.toFixed(1))} / 5</div>

            <div class="small-score"><strong>コメント:</strong><br>${entry.comment}</div>
          `;
          logContainer.appendChild(logEntry);
        });

        if (reviews.length > 0) {
          const avg = totalScore / reviews.length;
          averageRating.textContent = `平均総合評価: ${avg.toFixed(1)} 点 (${reviews.length} 件)`;
        } else {
          averageRating.textContent = "まだ投稿がありません";
        }
      }

      document.getElementById("reviewForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const newReview = {
          ui: Number(document.getElementById("uiScore").value),
          features: Number(document.getElementById("featureScore").value),
          stability: Number(document.getElementById("stabilityScore").value),
          rating: currentRating,
          comment: document.getElementById("reviewText").value,
        };

        await fetch("/api/reviews", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newReview),
        });

        currentRating = 0;
        highlightPaws(currentRating);
        ratingValue.textContent = "現在の総合評価: 0.0";
        document.getElementById("reviewText").value = "";

        fetchReviews();
      });

      fetchReviews();
    </script>
  </body>
</html>
